#!/bin/bash

cat_example() {
	cat <<EOF
----- >8 -----------------------------------------------------------------------

/* --- messages --- */

struct  _Message
{
  ProtobufCMessage base;
  protobuf_c_boolean has_type;
  int32_t type;
  char *data;
};
#define MESSAGE__INIT \
 { PROTOBUF_C_MESSAGE_INIT (&message__descriptor) \
    , 0,0, NULL }


/* Message methods */
void   message__init
                     (Message         *message);
size_t message__get_packed_size
                     (const Message   *message);
size_t message__pack
                     (const Message   *message,
                      uint8_t             *out);
size_t message__pack_to_buffer
                     (const Message   *message,
                      ProtobufCBuffer     *buffer);
Message *
       message__unpack
                     (ProtobufCAllocator  *allocator,
                      size_t               len,
                      const uint8_t       *data);
void   message__free_unpacked
                     (Message *message,
                      ProtobufCAllocator *allocator);
/* --- per-message closures --- */

typedef void (*Message_Closure)
                 (const Message *message,
                  void *closure_data);

/* --- services --- */

----- >8 -----------------------------------------------------------------------
message Message {
	int32 type = 1;
	string data = 2;
}
EOF

	cat <<EOF
----- >8 -----------------------------------------------------------------------

/* --- enums --- */

typedef enum _Corpus {
  CORPUS__UNIVERSAL = 0,
  CORPUS__WEB = 1,
  CORPUS__IMAGES = 2,
  CORPUS__LOCAL = 3,
  CORPUS__NEWS = 4,
  CORPUS__PRODUCTS = 5,
  CORPUS__VIDEO = 6
    PROTOBUF_C__FORCE_ENUM_TO_BE_INT_SIZE(CORPUS)
} Corpus;

/* --- messages --- */

enum Corpus {
	UNIVERSAL = 0;
	WEB = 1;
	IMAGES = 2;
	LOCAL = 3;
	NEWS = 4;
	PRODUCTS = 5;
	VIDEO = 6;
}
EOF
}

#sed -n \
#    -e '/struct  _/,/};/{/^struct  _/s,struct  _\(.*\),message \1 {,;/ProtobufCMessage/d;/protobuf_c_boolean/d;p}' \
#    -e '/struct  _/,/};/{/int32_t/s,_t,xx,p}' \
#    "$@"



enum() {
	sed -n -e '/typedef enum _/,/} .\+;/p' "$@" |
	sed    -e '/^typedef enum _/s,typedef enum _\(.*\) {,enum \1 {,;/PROTOBUF_C__/d' \
	       -e '/^  .\+__.\+ = /s/[A-Z0-9_]\+__\([A-Z0-9_]\+ = [0-9]\+\),\?/\1;/' \
	       -e '/^} .\+;$/s, .\+;,,'
}

message() {
	sed -n -e '/struct  _/,/};/p' "$@" |
	sed    -e '/^struct  _/s,struct  _\(.*\),message \1 {,;/ProtobufCMessage/d;/protobuf_c_boolean/d;/^{/d' \
	       -e '/int[0-9]\+_t/s,_t,,' \
	       -e '/char \+\*/s,char \+\*,string ,' \
	       -e '/^};$/s,;$,,'
}

protoc() {
	echo "/* Generated by the protocol buffer DEcompiler.  EDIT AS NEEDED! */"
	echo

	echo "syntax = \"proto3\";"
	echo

	echo "/* === enums === */"
	echo
	enum "$@"

	echo
	echo "/* === messages === */"
	echo
	message "$@"
}

protoc "$@" | \
while read -r line; do
	if [[ $line =~ ^} ]]; then
		unset index
		unset indent
	elif [[ $index ]]; then
		index="$((index+1))"
		line="${line/;/ = $index;}"
	elif [[ $line =~ ^message ]]; then
		indent="  "
		index="0"
		echo "$line"
		continue
	elif [[ $line =~ ^enum ]]; then
		indent=y
		echo "$line"
		indent="  "
		continue
	fi
	echo "$indent$line"
done
